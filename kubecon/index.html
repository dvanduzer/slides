<!doctype html><head><script src="../eveal.js/eveal.js"></script></head><body>
<style>code { background-color:#eee; color:#900; }</style>


# KubeCon 2018
## Seattle, WA

<small>
  @tracey_pooh<br/>
  @dvanduzer<br/>

  2018 December
</small>

<small>
  _?_ for keyboard shortcuts
</small><br/>
https://github.com/traceypooh/slides

---
# The Internet Archive
## Moving to Kubernetes

---
<!-- .slide: data-background="ia-truck-cartoon.jpg" -->
<img src="sign.png" style="position:fixed; right:0; top:0; background: 0"/>

<small style="position:fixed; bottom:0; color:white !important">credit: www.flickr.com/photos/cassidy/6898197626</small>

---
# Ever Coming Soon!
<img height="500" data-src="NWL_Press_DontIronWhileStrikeisHot_122116.jpg"/>

---
# Intro to archive.org
- 300B+ web pages _WayBack Machine_
- 15M books <small>lendable</small>
- 4M videos
- 4M audio & concerts
- 3M images
- 200K software items & emulation
---
<a href="https://web.archive.org/web/19961219202222/http://www.apple.com:80/">
  <img style="height:700px" src="i/wayback-apple.png"/>
</a>
---
<a href="https://archive.org/details/goodytwoshoes00newyiala">
  <img style="height:700px" src="i/bookreader.jpg"/>
</a>
---
<a href="https://archive.org/details/msdos_Pac-Man_1983">
  <img style="height:700px" src="i/software.png"/>
</a>
---
<a href="https://archive.org/details/Sita_Sings_the_Blues">
  <img style="height:700px" src="i/av.jpg"/>
</a>

---
# Library!
- Absolute browser Privacy
  - no personal data or IP addresses extracted
- Validation & nontampering
  - keep original versions with 2+ checksums and logs
```xml
<file name="commute.mp4" source="derivative">
<title>commute</title>
<format>h.264</format>
<original>commute.avi</original>
<mtime>1325973601</mtime>
<size>11919082</size>
<md5>ff17ed66e7db5693dd208dd6ac488ff8</md5>
<crc32>ad1df03a</crc32>
<sha1>e9f9de8379cd25653d487ab30d198fc61a050091</sha1>
<length>115.61</length>
<height>480</height>
<width>640</width>
</file>
```

---
# Where we Are
- rapidly moving webapps to k8
  - archive.org website ready
  - bookscanning and mgmt webapps
  - dweb.me
- AWS-like k8 `✔`
- EC2-like k8 `✔`

---
# .. But!
- still more comfortable w/ block-device storage than torrented pieces for entire data Archives
  - eg: S3 => K8 or o/w -- seems anxiety++

---
# www-xxx (bespoke) -v- review apps (k8)
- contractors can work/test full site
  - w/o ssh keys/access
  - 12h timezone shift OK
    - no staff/approval need - `game changer!`
- git branches => 'review apps' consistent/update over time
- `kre8/branch-sync-edit.sh`
  - 'copy file change to pod on save' fast script
  - webapp instant f/b w/o full push and CI/CD

---
# MonoRepo speed++
- 4.8G tree => [6..9] GB docker images
- `test` phase _first_ = faster (when possible)
- takeover git mgmt
  - naive `git clone` every CI/CD phase = nonstarter
- build/test code in same tree
  - `RUN ..` move git tree up to head of master first
  - `RUN ..` reinvoke build script (now at master);
    - move git tree pointer back to `$COMMIT`

---
# Monorepo .git
- `$FETCH` either:
  - `master:master`
  - `master:master my-awesome-branch:ca6745`
- `$CHECKOUT` either:
  - `master` or `my-awesome-branch` (head) or `ca6745`
- `git shallow clone`
  - (docker image basis; recut weekly or so; baseline image used in each phase)

---
# Monorepo .git
- `git checkout --detach`
  - avoid tangle with git tree state
- `git fetch -depth 1 -f -origin $FETCH`
  - git 'advertised' commits
  - ```omnibus_gitconfig['system'] = {"uploadpack" => ["allowReachableSHA1InWant = true"]}```
- `git checkout -f $CHECKOUT`
  - reset HEAD pointer to state in _origin's_ branch/commit
  - (makes our concept of branch/commit now be same as origin's)

- `build` pull from prior branch's build saved in registry


---
# 'on prem' K8 cluster from scratch
- https://gitlab.com/internetarchive/kre8
  <img style="width:10%; vertical-align:middle" data-src="i/pirate-coin-rotated-small.png"/>
  - shows/uses GitLab 'Auto DevOps' CI/CD end-to-end
  - need 1+ VM w/ ssh access and sudo
    - (ubuntu based so far)
  - uses `kubeadm`
  - coworker can try out - low committment

---
# Top Tips
- `POSTGRES_ENABLED=false` CI/CD var
  - avoids extra (unused!) PV per branch/deploy
- can use simple `localstorage` for 1 (tainted) or 2-node k8 clusters
- periodically: remove old replicasets, trim registry
- GitLab API for last master `test` phase status
  - 'OK to push live?'

---
# LB vs ingress for alt ports
- `kubectl expose -ndweb deployment/production --type=LoadBalancer --name=porter`
- `kubectl patch  -ndweb svc/porter -p='{"spec":{"externalIPs":["'${K8_INGRESS_IP?}"]}}'`

---
<!-- .slide: data-background="https://media.giphy.com/media/Gdjgn0hy8zBRK/giphy.gif" -->
# The End

